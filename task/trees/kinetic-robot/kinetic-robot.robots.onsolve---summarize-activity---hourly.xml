<tree schema_version="1.0">
<sourceName>Kinetic Robot</sourceName>
<sourceGroup>Robots</sourceGroup>
<type>Tree</type>
<status>Active</status>
<taskTree builder_version="" schema_version="1.0" version="">
    <name>OnSolve - Summarize Activity - Hourly</name>
    <author/>
    <notes/>
    <lastID>53</lastID>
    <request>
        <task definition_id="system_start_v1" id="start" name="Start" x="10" y="10">
            <version>1</version>
            <configured>true</configured>
            <defers>false</defers>
            <deferrable>false</deferrable>
            <visible>false</visible>
            <parameters/>
            <messages/>
            <dependents>
                
            <task label="Robot Initiated" type="Complete" value="if @source['Data']&#xA;  JSON.parse(@source['Data']).has_key? ('Kinetic Robot Execution Record Id')&#xA;else &#xA;  false&#xA;end">kinetic_request_ce_datastore_submission_update_v1_1</task>
                
            <task label="Not from Robot" type="Complete" value="if !@source['Data']&#xA;  true&#xA;elsif !JSON.parse(@source['Data']).has_key? ('Kinetic Robot Execution Record Id')&#xA;  true&#xA;else&#xA;  false&#xA;end">utilities_echo_v1_41</task>
            </dependents>
        </task>
    
        <task definition_id="kinetic_request_ce_datastore_submission_update_v1" id="kinetic_request_ce_datastore_submission_update_v1_1" name="Update Robot Execution Status" x="14" y="99">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being updated in (defaults to info value if not provided)."/>
        <parameter id="submission_id" label="Datastore Submission Id" menu="" required="true" tooltip="The id of the submission being updated.">&lt;%=JSON.parse(@source['Data'])['Kinetic Robot Execution Record Id']%&gt;</parameter>
        <parameter id="state" label="State" menu="" required="false" tooltip="The value used to set the submission state."/>
        <parameter id="values" label="Values" menu="" required="false" tooltip="A JSON map of field names to values that should be set.">{"Status":"Running"}</parameter>
        <parameter id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."/>
        <parameter id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
            <task label="" type="Complete" value="">utilities_echo_v1_41</task>
            </dependents>
    </task>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="utilities_create_trigger_v1" id="utilities_create_trigger_v1_15" name="Robot return trigger" x="495" y="329">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="action_type" label="Action Type" menu="Update,Complete" required="true" tooltip="">Complete</parameter>
        <parameter id="deferral_token" label="Deferral Token" menu="" required="true" tooltip="">&lt;%=JSON.parse(@source['Data'])['Kinetic Robot Deferral Token']%&gt;</parameter>
        <parameter id="deferred_variables" label="Deferred Results" menu="" required="false" tooltip="">&lt;results&gt;
&lt;result name="output"&gt;{"message":"Summarized Data"}&lt;/result&gt;
&lt;/results&gt;</parameter>
        <parameter id="message" label="Message" menu="" required="false" tooltip=""/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
            
            <task label="" type="Complete" value="">system_junction_v1_50</task>
            </dependents>
    </task>
      
        
      
        <task definition_id="system_noop_v1" id="system_noop_v1_17" name="End" x="23" y="351">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents/>
    </task>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="utilities_echo_v1" id="utilities_echo_v1_41" name="Placeholder: Integration Source List" x="168" y="111">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;formSlugs&gt;&lt;formSlug&gt;Incident Management Test&lt;/formSlug&gt;&lt;/formSlugs&gt;</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">utilities_echo_v1_44</task>
            </dependents>
    </task>
      
        <task definition_id="system_loop_head_v1" id="system_loop_head_v1_42" name="Loop Begin" x="497" y="132">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters>
        <parameter id="data_source" label="Data Source:" menu="" required="true" tooltip="The source that contains the data to use to create each task in the loop.">&lt;%=@results['Placeholder: Integration Source List']['output']%&gt;</parameter>
        <parameter id="loop_path" label="Loop Path:" menu="" required="true" tooltip="The XPath statement to indicate what data records to process.">/formSlugs/formSlug</parameter>
        <parameter id="var_name" label="Variable Name:" menu="" required="false" tooltip="The local variable name used to represent the data used in loop tasks.">formSlug</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">system_loop_tail_v1_43</task>
                
            <task type="Complete" label="" value="">routine_onsolve_task_activity_monitor_submission_count_v1_53</task></dependents>
    </task>
      
        <task definition_id="system_loop_tail_v1" id="system_loop_tail_v1_43" name="Loop End" x="495" y="229">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters>
        <parameter id="type" label="Type:" menu="All,Some,Any" required="true" tooltip="How many loop processes must be completed before continuing?">All</parameter>
        <parameter dependsOnId="type" dependsOnValue="Some" id="number" label="Number:" menu="" required="false" tooltip="If some, how many?"/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="Robot Initiated" type="Complete" value="if @source['Data']&#xA;  JSON.parse(@source['Data']).has_key? ('Kinetic Robot Execution Record Id')&#xA;else &#xA;  false&#xA;end">utilities_create_trigger_v1_15</task>
                <task label="Not from Robot" type="Complete" value="if !@source['Data']&#xA;  true&#xA;elsif !JSON.parse(@source['Data']).has_key? ('Kinetic Robot Execution Record Id')&#xA;  true&#xA;else&#xA;  false&#xA;end">system_junction_v1_50</task>
            </dependents>
    </task>
      
        <task definition_id="utilities_echo_v1" id="utilities_echo_v1_44" name="Determine Start and End Times" x="328" y="110">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
current_time = Time.now

one_hour_ago = current_time - 3600

output = {}
output['Start Time'] = Time.new(one_hour_ago.year, one_hour_ago.month, one_hour_ago.day, one_hour_ago.hour).utc.iso8601
output['End Time'] = Time.new(current_time.year, current_time.month, current_time.day, current_time.hour).utc.iso8601
output['UTC Hour'] = one_hour_ago.utc.hour

output.to_json%&gt;</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">system_loop_head_v1_42</task>
            </dependents>
    </task>
      
        
      
        <task definition_id="kinetic_request_ce_submission_create_v1" id="kinetic_request_ce_submission_create_v1_46" name="Write Summary Submission" x="660" y="209">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."/>
        <parameter id="kapp_slug" label="Kapp Slug" menu="" required="true" tooltip="The slug of the Kapp the submission is for.">task-activity-monitor</parameter>
        <parameter id="form_slug" label="Form Slug" menu="" required="true" tooltip="The slug of the form the submission is for.">task-activity-dashboard-hourly</parameter>
        <parameter id="values" label="Values" menu="" required="false" tooltip="JSON map of submission field values.">&lt;%=
t = Time.parse(JSON.parse(@results['Determine Start and End Times']['output'])['Start Time'])
time_bucket = []
time_bucket.push(t.strftime("%Y"))
time_bucket.push(t.strftime("%Y-%m"))
time_bucket.push(t.strftime("%F"))
time_bucket.push(t.strftime("%F-#{JSON.parse(@results['Determine Start and End Times']['output'])['UTC Hour']}"))
time_bucket.push(t.strftime("%FT#{JSON.parse(@results['Determine Start and End Times']['output'])['UTC Hour']}"))

{
"Source" =&gt; "#{@results['Loop Begin']['Value']}",
"Start Time" =&gt; "#{JSON.parse(@results['Determine Start and End Times']['output'])['Start Time']}",
"Count" =&gt; "#{@results['Get last hour count']['Total Count']}",
"UTC Hour" =&gt; "#{JSON.parse(@results['Determine Start and End Times']['output'])['UTC Hour']}",
"Start Time Bucket" =&gt; time_bucket
}.to_json%&gt;</parameter>
        <parameter id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."/>
        <parameter id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."/>
        <parameter id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."/>
        <parameter id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">system_loop_tail_v1_43</task>
                <task label="" type="Complete" value="">kinetic_request_ce_submission_update_v1_51</task>
            </dependents>
    </task>
      
        <task definition_id="kinetic_request_ce_datastore_submission_create_v1" id="kinetic_request_ce_datastore_submission_create_v1_47" name="Add Task Run Cleanup Entry" x="176" y="329">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being created in (defaults to info value if not provided)."/>
        <parameter id="form_slug" label="Datastore Form Slug" menu="" required="true" tooltip="The slug of the datastore form the submission is for.">task-run-cleanup</parameter>
        <parameter id="values" label="Values" menu="" required="false" tooltip="JSON map of submission field values.">&lt;%={
  "Task Run Id" =&gt; @run['Id'],
  "Delete After Date Time" =&gt; (Time.now + (86400 * 1])).iso8601
}.to_json%&gt;</parameter>
        <parameter id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."/>
        <parameter id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">system_noop_v1_17</task>
            </dependents>
    </task>
      
        
      
        
      
        <task definition_id="system_junction_v1" id="system_junction_v1_50" name="Junction" x="330" y="352">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">kinetic_request_ce_datastore_submission_create_v1_47</task>
            </dependents>
    </task>
      
        <task definition_id="kinetic_request_ce_submission_update_v1" id="kinetic_request_ce_submission_update_v1_51" name="Close Submission" x="803" y="218">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."/>
        <parameter id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission being updated.">&lt;%=@results['Write Summary Submission']['Submission ID']%&gt;</parameter>
        <parameter id="state" label="State" menu="" required="false" tooltip="The value used to set the submission state.">Closed</parameter>
        <parameter id="values" label="Values" menu="" required="false" tooltip="A JSON map of field names to values that should be set."/>
        <parameter id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."/>
        <parameter id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."/>
        <parameter id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."/>
        <parameter id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents/>
    </task>
      
        
      
        <task name="Get last hour count" id="routine_onsolve_task_activity_monitor_submission_count_v1_53" definition_id="routine_onsolve_task_activity_monitor_submission_count_v1" x="659" y="121">
      <version>1</version>
      <configured>true</configured>
      <defers>true</defers>
      <deferrable>true</deferrable>
      <visible>false</visible>
      <parameters>
            <parameter id="Kapp Slug" label="Kapp Slug" required="true" tooltip="" menu="">task-activity-monitor</parameter>
            <parameter id="Starting Count" label="Starting Count" required="true" tooltip="" menu="">0</parameter>
            <parameter id="Start Time" label="Start Time" required="true" tooltip="" menu="">&lt;%=JSON.parse(@results['Determine Start and End Times']['output'])['Start Time']%&gt;</parameter>
            <parameter id="End Time" label="End Time" required="true" tooltip="" menu="">&lt;%=JSON.parse(@results['Determine Start and End Times']['output'])['End Time']%&gt;</parameter>
            <parameter id="Source" label="Source" required="true" tooltip="" menu="">&lt;%=@results['Loop Begin']['Value']%&gt;</parameter>
            <parameter id="Page Token" label="Page Token" required="false" tooltip="The value to use as the offset for the page of submissions to return. The submission that matches this value will not be included in the results." menu=""/>
        </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task type="Complete" label="" value="">kinetic_request_ce_submission_create_v1_46</task></dependents>
    </task>
      </request>
</taskTree></tree>