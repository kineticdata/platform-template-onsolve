<tree schema_version="1.0">
<sourceName>OnSolve</sourceName>
<sourceGroup>Integrations</sourceGroup>
<type>Tree</type>
<status>Active</status>
<taskTree builder_version="" schema_version="1.0" version="">
    <name>ServiceNow Standard Notification Initiation Process</name>
    <author/>
    <notes/>
    <lastID>112</lastID>
    <request>
        <task definition_id="system_start_v1" id="start" name="Start" x="10" y="10">
            <version>1</version>
            <configured>true</configured>
            <defers>false</defers>
            <deferrable>false</deferrable>
            <visible>false</visible>
            <parameters/>
            <messages/>
            <dependents>
            
            <task label="" type="Complete" value="">kinetic_request_ce_submission_activity_create_v1_96</task></dependents>
        </task>
    
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="utilities_echo_v1" id="utilities_echo_v1_12" name="Placeholder: SWN Routine / Tree / Handler" x="803" y="755">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="input" label="Input" menu="" required="true" tooltip="">*No action: Placeholder*</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
            <task label="" type="Complete" value="">system_noop_v1_54</task>
            </dependents>
    </task>
      
        
      
        <task definition_id="system_junction_v1" id="system_junction_v1_14" name="Junction" x="1021" y="286">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
            
                
            
            <task type="Complete" label="" value="">utilities_create_trigger_v1_94</task></dependents>
    </task>
      
        
      
        
      
        <task definition_id="system_noop_v1" id="system_noop_v1_17" name="End" x="1486" y="275">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents/>
    </task>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="utilities_echo_v1" id="utilities_echo_v1_35" name="Process Placeholders" x="176" y="439">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
#placeholder_entries = JSON.parse(@results['Retrieve Integration Config']['Values JSON'])
integration_config = JSON.parse( @source['Data'] )['Integration Configuration']
placeholders = JSON.parse( integration_config['Placeholder Data'] || "[]" )

## Review each placeholder and handle any replacements in the values field.
#  Set up source data
source_data = JSON.parse( @source['Data'] )['Source Data']

#  Do replacements
placeholders.each_index{|i|
  ph = placeholders[i]['value']
  if !ph.nil?
    ph.gsub!(/\{\{(?:(?!\{\{).)*?\}\}/) do |match|
      # remove opening and closing brackets from match
      key = match[2..-3]

      # determine which part of the field to retrieve - the 'display_value' or the 'value'
      field_qualifier = 'value'
      field = key
      field_array = key.split(".")
      if field_array.length &gt; 0
        if ["display_value","value"].include? field_array[1]
          field_qualifier = field_array[1]
        end
        field = field_array[0]
      end

      if source_data.keys.include?(field)
        source_data[field][field_qualifier]
      else
        match
      end
    end
    placeholders[i]['value'] = ph
  end
}

placeholders.to_json
%&gt;</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
                <task label="" type="Complete" value="">utilities_echo_v1_88</task>
            </dependents>
    </task>
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="kinetic_request_ce_datastore_submission_retrieve_v1" id="kinetic_request_ce_datastore_submission_retrieve_v1_41" name="Retrieve Notification XML" x="11" y="444">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."/>
        <parameter id="retrieve_by" label="Retrieve By" menu="Id,Query" required="true" tooltip="How to retrieve the submission. Id or Query.">Query</parameter>
        <!-- Retrieve By Query parameters -->
        <parameter dependsOnId="retrieve_by" dependsOnValue="Query" id="form_slug" label="Datastore Form Slug" menu="" required="false" tooltip="Slug of the form to query">onsolve-notifications</parameter>
        <parameter dependsOnId="retrieve_by" dependsOnValue="Query" id="index" label="Index" menu="" required="false" tooltip="The index to use for the search/retrieval">values[Notification Name]</parameter>
        <parameter dependsOnId="retrieve_by" dependsOnValue="Query" id="query" label="Query" menu="" required="false" tooltip="A query that will retrieve a single submission">values[Notification Name] = "&lt;%= JSON.parse( @source['Data'] )['Integration Configuration']['Notification Message Template']%&gt;"</parameter>
        <!-- Retrieve By Id parameters -->
        <parameter dependsOnId="retrieve_by" dependsOnValue="Id" id="submission_id" label="Datastore Submission Id" menu="" required="false" tooltip="The id of the submission being retrieved."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">utilities_echo_v1_35</task>
            </dependents>
    </task>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="kinetic_request_ce_submission_update_v1" id="kinetic_request_ce_submission_update_v1_53" name="Update Submission with UUID" x="1023" y="127">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."/>
        <parameter id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission being updated.">&lt;%= JSON.parse( @source['Data'] )['Task Activity Monitor Submission']%&gt;</parameter>
        <parameter id="state" label="State" menu="" required="false" tooltip="The value used to set the submission state."/>
        <parameter id="values" label="Values" menu="" required="false" tooltip="A JSON map of field names to values that should be set.">&lt;%=
{
 "Onsolve Id" =&gt; @results['MIR3 One Step Notification']['Notification Report UUID'],
 "Onsolve Status" =&gt; "Open"
}.to_json
%&gt;</parameter>
        <parameter id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."/>
        <parameter id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."/>
        <parameter id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."/>
        <parameter id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
            <task type="Complete" label="" value="">kinetic_request_ce_submission_activity_update_v1_97</task></dependents>
    </task>
      
        <task definition_id="system_noop_v1" id="system_noop_v1_54" name="Placeholder: Update Submission w/SWN ID" x="1021" y="770">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                <task label="" type="Complete" value="">system_junction_v1_14</task>
            </dependents>
    </task>
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="servicenow_object_update_v1" id="servicenow_object_update_v1_84" name="Update ServiceNow - Alerting Initiated" x="1352" y="120">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
    <parameter id="table" label="Table" menu="" required="true" tooltip="The name of the table to update the object in (ie. change_request,incident,task,etc).">&lt;%= JSON.parse( @source['Data'] )['Integration Configuration']['Schema Name']%&gt;</parameter>
    <parameter id="id" label="Id" menu="" required="true" tooltip="The id of the object to update.">&lt;%= JSON.parse( @source['Data'] )['Source Id']%&gt;</parameter>
    <parameter id="json_body" label="JSON Body" menu="" required="true" tooltip="The JSON body containing the fields that should be updated.">&lt;%=
work_notes = ["Alerting Initiated"]
work_notes.push( "MIR3 UUID: #{@results['MIR3 One Step Notification']['Notification Report UUID']}" )

{ "work_notes" =&gt; work_notes.join("\n") }.to_json
%&gt;</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents/>
    </task>
      
        
      
        
      
        
      
        <task definition_id="utilities_echo_v1" id="utilities_echo_v1_88" name="Do Recipient Replacements" x="339" y="428">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
recipients = JSON.parse( @source['Data'] )['Integration Configuration']['Recipients JSON']
source_data = JSON.parse( @source['Data'] )['Source Data']

#  Do replacements
if !recipients.nil?
  recipients.gsub!(/\{\{(?:(?!\{\{).)*?\}\}/) do |match|
    # remove opening and closing brackets from match
    key = match[2..-3]

    # determine which part of the field to retrieve - the 'display_value' or the 'value'
    field_qualifier = 'value'
    field = key
    field_array = field.split(".")
    if field_array.length &gt; 0
      if ["display_value","value"].include? field_array[1]
        field_qualifier = field_array[1]
      end
      field = field_array[0]
    end

    if source_data.keys.include?(field)
      source_data[field][field_qualifier]
    else
      match
    end
  end
end

recipients
%&gt;</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
            
            <task label="Uses ServiceNow OnCall" type="Complete" value="JSON.parse( @source['Data'] )['Integration Configuration']['Use ServiceNow Oncall'].to_s == &quot;Yes&quot; &amp;&amp; !JSON.parse( @source['Data'] )['Integration Configuration']['OnCall Support Group Id'].to_s.empty?">servicenow_oncall_retrieve_v1_100</task><task label="MIR3" type="Complete" value="JSON.parse( @source['Data'] )['Onsolve Product'] === &quot;MIR3&quot;">system_junction_v1_106</task><task label="SWN" type="Complete" value="JSON.parse( @source['Data'] )['Onsolve Product'] === &quot;SWN&quot;">system_junction_v1_107</task></dependents>
    </task>
      
        
      
        
      
        
      
        
      
        
      
        <task definition_id="utilities_create_trigger_v1" id="utilities_create_trigger_v1_94" name="Return Trigger" x="1185" y="275">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="action_type" label="Action Type" menu="Update,Complete" required="true" tooltip="">Complete</parameter>
        <parameter id="deferral_token" label="Deferral Token" menu="" required="true" tooltip="">&lt;%= JSON.parse( @source['Data'] )['Deferral Token']%&gt;</parameter>
        <parameter id="deferred_variables" label="Deferred Results" menu="" required="false" tooltip="">&lt;results&gt;
  &lt;result name="Onsolve Notification UUID"&gt;&lt;%=@results['MIR3 One Step Notification']['Notification Report UUID']%&gt;&lt;/result&gt;
  &lt;result name="Success"&gt;&lt;%=@results['MIR3 One Step Notification']['Success']%&gt;&lt;/result&gt;
&lt;/results&gt;</parameter>
        <parameter id="message" label="Message" menu="" required="false" tooltip=""/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
                <task label="Not Forever" type="Complete" value="JSON.parse( @source['Data'] )['Integration Configuration']['Keep Task History'] == &quot;Not Forever&quot;">kinetic_request_ce_datastore_submission_create_v1_95</task>
            <task label="Forever" type="Complete" value="JSON.parse( @source['Data'] )['Integration Configuration']['Keep Task History'] != &quot;Not Forever&quot;">system_junction_v1_99</task></dependents>
    </task>
      
        <task definition_id="kinetic_request_ce_datastore_submission_create_v1" id="kinetic_request_ce_datastore_submission_create_v1_95" name="Add Task Run Cleanup Entry" x="1283" y="407">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being created in (defaults to info value if not provided)."/>
        <parameter id="form_slug" label="Datastore Form Slug" menu="" required="true" tooltip="The slug of the datastore form the submission is for.">task-run-cleanup</parameter>
        <parameter id="values" label="Values" menu="" required="false" tooltip="JSON map of submission field values.">&lt;%=
duration = JSON.parse( @source['Data'] )['Integration Configuration']['Task History Duration'].to_i

{
  "Task Run Id" =&gt; @run['Id'],
  "Delete After Date Time" =&gt; (Time.now + (86400 * duration)).iso8601
}.to_json%&gt;</parameter>
        <parameter id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."/>
        <parameter id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents>
                
            <task label="" type="Complete" value="">system_junction_v1_99</task></dependents>
    </task>
      
        <task definition_id="kinetic_request_ce_submission_activity_create_v1" id="kinetic_request_ce_submission_activity_create_v1_96" name="Add Activity Record" x="11" y="222">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission exists in (defaults to info value if not provided)."/>
        <parameter id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission for which the activity is being created for.">&lt;%=JSON.parse(@source['Data'])['Task Activity Monitor Submission']%&gt;</parameter>
        <parameter id="label" label="Label" menu="" required="false" tooltip="The label for the submission activity.">MIR3 Notification Initiation</parameter>
        <parameter id="description" label="Description" menu="" required="false" tooltip="The description of the submission activity."/>
        <parameter id="type" label="Type" menu="" required="false" tooltip="Specifies the a submission activity 'Type', which should indicate what type of data is included.">Notification Initiated</parameter>
        <parameter id="data" label="Data" menu="" required="false" tooltip="Additional data that can be used by resources consuming the submission activity record (for example a Request bundle may render submission details based upon JSON content in the activity data).">&lt;%=
{
  "Task Run Id" =&gt; @run['Id'],
  "Status" =&gt; "In Process"
}.to_json
%&gt;</parameter>
    </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="" type="Complete" value="">kinetic_request_ce_datastore_submission_retrieve_v1_41</task></dependents>
    </task>
      
        <task definition_id="kinetic_request_ce_submission_activity_update_v1" id="kinetic_request_ce_submission_activity_update_v1_97" name="Update Activity Record" x="1189" y="132">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission exists in (defaults to info value if not provided)."/>
        <parameter id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission for which the activity is being created for.">&lt;%=JSON.parse(@source['Data'])['Task Activity Monitor Submission']%&gt;</parameter>
        <parameter id="submission_activity_id" label="Submission Activity Id" menu="" required="true" tooltip="The id of the submission for which the activity is being created for.">&lt;%=@results['Add Activity Record']['Id']%&gt;</parameter>
        <parameter id="label" label="Label" menu="" required="false" tooltip="The label for the submission activity.">MIR3 Notification Initiation</parameter>
        <parameter id="description" label="Description" menu="" required="false" tooltip="The description of the submission activity."/>
        <parameter id="type" label="Type" menu="" required="false" tooltip="Specifies the a submission activity 'Type', which should indicate what type of data is included.">Notification Initiated</parameter>
        <parameter id="data" label="Data" menu="" required="false" tooltip="Additional data that can be used by resources consuming the submission activity record (for example a Request bundle may render submission details based upon JSON content in the activity data).">&lt;%=
comments = "MIR3 UUID: #{@results['MIR3 One Step Notification']['Notification Report UUID']}" if @results.has_key? ('MIR3 One Step Notification')

{
  "Task Run Id" =&gt; @run['Id'],
  "Status" =&gt; "Completed",
  "Comments" =&gt; comments
}.to_json
%&gt;</parameter>
    </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task type="Complete" label="If updates configured" value="JSON.parse( @source['Data'] )['Integration Configuration']['Notification Initiation Action'] != &quot;None&quot;">servicenow_object_update_v1_84</task></dependents>
    </task>
      
        
      
        <task definition_id="system_junction_v1" id="system_junction_v1_99" name="Junction: End" x="1351" y="265">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="" type="Complete" value="">system_noop_v1_17</task></dependents>
    </task>
      
        <task definition_id="servicenow_oncall_retrieve_v1" id="servicenow_oncall_retrieve_v1_100" name="Retrieve OnCall" x="506" y="433">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
        <parameter id="api_route" label="API Route" menu="" required="true" tooltip="The name of the OnCall API route.  Default: whoisoncall">whoisoncall</parameter>
        <parameter id="api_parameters" label="api_parameters" menu="" required="true" tooltip="API parameters, values must be encoded.">&lt;%=
oncall = JSON.parse( @source['Data'] )['Integration Configuration']['OnCall Support Group Id']
source_data = JSON.parse( @source['Data'] )['Source Data']

#  Do replacements
if !oncall.nil?
  oncall.gsub!(/\{\{(?:(?!\{\{).)*?\}\}/) do |match|
    # remove opening and closing brackets from match
    key = match[2..-3]

    # determine which part of the field to retrieve - the 'display_value' or the 'value'
    field_qualifier = 'value'
    field = key
    field_array = field.split(".")
    if field_array.length &gt; 0
      if ["display_value","value"].include? field_array[1]
        field_qualifier = field_array[1]
      end
      field = field_array[0]
    end

    if source_data.keys.include?(field)
      source_data[field][field_qualifier]
    else
      match
    end
  end
end

"group_ids=#{oncall}"
%&gt;</parameter>
    </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="" type="Complete" value="">servicenow_object_query_retrieve_v1_103</task></dependents>
    </task>
      
        
      
        
      
        <task definition_id="servicenow_object_query_retrieve_v1" id="servicenow_object_query_retrieve_v1_103" name="Get Oncall Users" x="660" y="429">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
        <parameter id="table" label="Table" menu="" required="true" tooltip="The name of the table to retrieve info from (ie. change_request,incident, task,etc).">sys_user</parameter>
        <parameter id="query" label="Query" menu="" required="true" tooltip="The query to retrieve objects. Use a '^' to seperate parameters.">&lt;%=
oncall_output = JSON.parse( @results['Retrieve OnCall']['object_json'] )
user_ids = oncall_output.map{ |x|
  "sys_id=#{x['userId']}"
}
query = user_ids.join("^OR")
%&gt;</parameter>
        <parameter id="display_value" label="Display Value" menu="" required="false" tooltip="Return field display values (true), actual values (false), or both (all) (default: false)."/>
        <parameter id="exclude_ref_link" label="Exclude Reference Link" menu="" required="false" tooltip="True to exclude Table API links for reference fields (default: false)."/>
        <parameter id="suppress_pag_header" label="Suppress Pagination Header" menu="" required="false" tooltip="True to supress pagination header (default: false)."/>
        <parameter id="fields" label="Fields" menu="" required="false" tooltip="A comma-separated list of fields to return in the response.">&lt;%=
service_now_identifier_field = JSON.parse( @source['Data'] )['Integration Configuration']['Unique Individual Identifier Field']

"sys_id,#{service_now_identifier_field}"
%&gt;</parameter>
        <parameter id="limit" label="Limit" menu="" required="false" tooltip="The maximum number of results returned per page (default: 10,000)."/>
        <parameter id="query_category" label="Query Category" menu="" required="false" tooltip="Name of the query category (read replica category) to use for queries."/>
    </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="" type="Complete" value="">utilities_echo_v1_104</task></dependents>
    </task>
      
        <task definition_id="utilities_echo_v1" id="utilities_echo_v1_104" name="Simplify OnCall" x="802" y="428">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
# identify the field that we're pulling back from ServiceNow
field = JSON.parse( @source['Data'] )['Integration Configuration']['User Field Containing Match to OnSolve Users']

# put oncall users into a hash for easy lookup
oncall_users = {}
JSON.parse( @results['Get Oncall Users']['object_json'] ).each{|user|
  oncall_users[user['sys_id']] = user[field]
}

oncall_results = JSON.parse( @results['Retrieve OnCall']['object_json'] ) 

simplified_oncall = {}

oncall_results.each{ |entry|
  order = entry['order'].to_i
  if !simplified_oncall.has_key? (order)
    simplified_oncall[order] = []
  end
  user = oncall_users[entry['userId']]
  simplified_oncall[order].push(user)
}

simplified_oncall.to_json
%&gt;
</parameter>
    </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="MIR3" type="Complete" value="JSON.parse( @source['Data'] )['Onsolve Product'] === &quot;MIR3&quot;">system_junction_v1_106</task><task label="SWN" type="Complete" value="JSON.parse( @source['Data'] )['Onsolve Product'] === &quot;SWN&quot;">system_junction_v1_107</task></dependents>
    </task>
      
        <task definition_id="routine_onsolve_mir3_one_step_notification_v1" id="routine_onsolve_mir3_one_step_notification_v1_105" name="MIR3 One Step Notification" x="803" y="128">
      <version>1</version>
      <configured>true</configured>
      <defers>true</defers>
      <deferrable>true</deferrable>
      <visible>false</visible>
      <parameters>
            <parameter id="Notification Detail" label="Notification Detail" menu="" required="true" tooltip="The title of the notification to be found and retrieved">&lt;%=JSON.parse(@results['Retrieve Notification XML']['Values JSON'])['Notification XML']%&gt;</parameter>
            <parameter id="Placeholder JSON" label="Placeholder JSON" menu="" required="false" tooltip="An object that contains the placeholder names and values: [{&quot;name&quot;:&quot;placeholder name&quot;, &quot;value&quot;:&quot;placeholder value&quot;},{&quot;name&quot;:&quot;placeholder name 2&quot;, &quot;value&quot;:&quot;placeholder value 2&quot;}...]">&lt;%=@results['Process Placeholders']['output']%&gt;</parameter>
            <parameter id="MIR3 Individual Recipient Field" label="MIR3 Individual Recipient Field" menu="" required="true" tooltip="The MIR3 field that contains the value(s) provided in the Individual Recipients List.  Required field, even if individual receipients is not populated.  Common values are 'employeeId' and 'username'">&lt;%= 
default = "username"
unique_field = JSON.parse( @source['Data'] )['Unique Individual Identifier Field']

if unique_field.to_s.empty?
  default
else
  unique_field
end
%&gt;

</parameter>
            <parameter id="Recipients JSON" label="Recipients JSON" menu="" required="true" tooltip="JSON object of recipients in one of two formats {&quot;individuals&quot;:&quot;...&quot;,&quot;groups&quot;:&quot;...&quot;,&quot;schedules&quot;:&quot;...&quot;} or {&quot;Escalation Level 1&quot;:{&quot;individuals&quot;:&quot;...&quot;,&quot;groups&quot;:&quot;...&quot;,&quot;schedules&quot;:&quot;...&quot;},&quot;Escalation Level 2&quot;:{...}}}">&lt;%=@results['Do Recipient Replacements']['output']%&gt;</parameter>
            <parameter id="OnCall JSON" label="OnCall JSON" menu="" required="false" tooltip="JSON object corresponding to ServiceNow Oncall, arranged as follows:  {&quot;1&quot;:[&quot;user1&quot;,&quot;user2&quot;],&quot;2&quot;:[&quot;user3&quot;],...}">&lt;%=
if @results.has_key? ('Simplify OnCall')
  @results['Simplify OnCall']['output']
end
%&gt;</parameter>
        </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="Successful" type="Complete" value="@results['MIR3 One Step Notification']['Success'] == &quot;true&quot;">kinetic_request_ce_submission_update_v1_53</task><task type="Complete" label="" value="">system_junction_v1_14</task><task type="Complete" label="Unsuccessful" value="@results['MIR3 One Step Notification']['Success'] != &quot;true&quot;">kinetic_request_ce_submission_update_v1_108</task><task type="Complete" label="Unsuccessful" value="@results['MIR3 One Step Notification']['Success'] != &quot;true&quot;">routine_onsolve_error_v1_111</task></dependents>
    </task>
      
        <task definition_id="system_junction_v1" id="system_junction_v1_106" name="Junction: SNow OnCall" x="803" y="271">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="" type="Complete" value="">routine_onsolve_mir3_one_step_notification_v1_105</task></dependents>
    </task>
      
        <task definition_id="system_junction_v1" id="system_junction_v1_107" name="Junction: SWN OnCall" x="803" y="588">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters/><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task label="" type="Complete" value="">utilities_echo_v1_12</task></dependents>
    </task>
      
        <task definition_id="kinetic_request_ce_submission_update_v1" id="kinetic_request_ce_submission_update_v1_108" name="Update Submission with UUID - Error" x="1024" y="32">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."/>
        <parameter id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission being updated.">&lt;%= JSON.parse( @source['Data'] )['Task Activity Monitor Submission']%&gt;</parameter>
        <parameter id="state" label="State" menu="" required="false" tooltip="The value used to set the submission state."/>
        <parameter id="values" label="Values" menu="" required="false" tooltip="A JSON map of field names to values that should be set.">&lt;%=
{
 "Onsolve Status" =&gt; "Initiation Error"
}.to_json
%&gt;</parameter>
        <parameter id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."/>
        <parameter id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."/>
        <parameter id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."/>
        <parameter id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."/>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task type="Complete" label="" value="">kinetic_request_ce_submission_activity_update_v1_109</task></dependents>
    </task>
      
        <task definition_id="kinetic_request_ce_submission_activity_update_v1" id="kinetic_request_ce_submission_activity_update_v1_109" name="Update Activity Record - Error" x="1189" y="33">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>false</visible>
      <parameters>
        <parameter id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Raise Error</parameter>
        <parameter id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission exists in (defaults to info value if not provided)."/>
        <parameter id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission for which the activity is being created for.">&lt;%=JSON.parse(@source['Data'])['Task Activity Monitor Submission']%&gt;</parameter>
        <parameter id="submission_activity_id" label="Submission Activity Id" menu="" required="true" tooltip="The id of the submission for which the activity is being created for.">&lt;%=@results['Add Activity Record']['Id']%&gt;</parameter>
        <parameter id="label" label="Label" menu="" required="false" tooltip="The label for the submission activity.">MIR3 Notification Initiation - Error</parameter>
        <parameter id="description" label="Description" menu="" required="false" tooltip="The description of the submission activity."/>
        <parameter id="type" label="Type" menu="" required="false" tooltip="Specifies the a submission activity 'Type', which should indicate what type of data is included.">Notification Initiated Error</parameter>
        <parameter id="data" label="Data" menu="" required="false" tooltip="Additional data that can be used by resources consuming the submission activity record (for example a Request bundle may render submission details based upon JSON content in the activity data).">&lt;%=
results = JSON.parse(@results['MIR3 One Step Notification']['Output'])['Full Output JSON']
comments = "MIR3 Initiation Error:\n" &lt;&lt; results['message']

{
  "Task Run Id" =&gt; @run['Id'],
  "Status" =&gt; "Errored",
  "Comments" =&gt; comments
}.to_json
%&gt;</parameter>
    </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents><task type="Complete" label="" value="">servicenow_object_update_v1_110</task></dependents>
    </task>
      
        <task definition_id="servicenow_object_update_v1" id="servicenow_object_update_v1_110" name="Update ServiceNow - Alerting Initiated - Error" x="1353" y="13">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
    <parameter id="table" label="Table" menu="" required="true" tooltip="The name of the table to update the object in (ie. change_request,incident,task,etc).">&lt;%= JSON.parse( @source['Data'] )['Integration Configuration']['Schema Name']%&gt;</parameter>
    <parameter id="id" label="Id" menu="" required="true" tooltip="The id of the object to update.">&lt;%= JSON.parse( @source['Data'] )['Source Id']%&gt;</parameter>
    <parameter id="json_body" label="JSON Body" menu="" required="true" tooltip="The JSON body containing the fields that should be updated.">&lt;%=
results = JSON.parse(@results['MIR3 One Step Notification']['Output'])['Full Output JSON']
work_notes = ["Alerting Initiated - Error"]
work_notes.push( "#{results['message']}" )

{ "work_notes" =&gt; work_notes.join("\n") }.to_json
%&gt;</parameter>
    </parameters>
            <messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents/>
    </task>
      
        <task name="OnSolve Error Notification" id="routine_onsolve_error_v1_111" definition_id="routine_onsolve_error_v1" x="626.9666442871094" y="133.9666748046875">
      <version>1</version>
      <configured>true</configured>
      <defers>true</defers>
      <deferrable>true</deferrable>
      <visible>false</visible>
      <parameters>
            <parameter id="Error Message Title" label="Error Message Title" required="true" tooltip="The title of the error message to be send with the error notification" menu="">&lt;%=
integration_config = JSON.parse( @source['Data'] )['Integration Configuration']
source_data = JSON.parse( @source['Data'] )['Source Data']
client_reference = source_data[integration_config['Display Reference Field Database Name']]

"Unable to initiate notification in MIR3 for #{client_reference} (integration: #{integration_config['Name']})"
%&gt;</parameter>
            <parameter id="Error Message Details" label="Error Message Details" required="true" tooltip="The error message details to be sent with the error notification" menu="">&lt;%=
results = JSON.parse(@results['MIR3 One Step Notification']['Output'])['Full Output JSON']
results['message']
%&gt;</parameter>
            <parameter id="Integration Id" label="Integration Id" required="false" tooltip="The Submission Id of the integration configuration record" menu=""/>
            <parameter id="Submission Id" label="Submission Id" required="false" tooltip="The Submission Id of the Task Activity Monitor record" menu="">&lt;%=JSON.parse(@source['Data'])['Task Activity Monitor Submission']%&gt;</parameter>
            <parameter id="Recipient List" label="Recipient List" required="false" tooltip="The receipient list to receive the notification" menu="">&lt;%=JSON.parse( @source['Data'] )['Integration Configuration']['Error Notification Email']%&gt;</parameter>
            <parameter id="Task Run" label="Task Run" required="false" tooltip="" menu="">&lt;%=@run['Id']%&gt;</parameter>
            <parameter id="Additional Info" label="Additional Info" required="false" tooltip="" menu=""/>
        </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents/>
    </task>
      
        <task name="Dev Notes - 01" id="utilities_echo_v1_112" definition_id="utilities_echo_v1" x="1484.9667053222656" y="90.08334350585938">
      <version>1</version>
      <configured>true</configured>
      <defers>false</defers>
      <deferrable>false</deferrable>
      <visible>true</visible>
      <parameters>
        <parameter id="input" label="Input" required="true" tooltip="" menu="">Decision was made to *always* update the Remedy ticket if there was an error in initiating the notification.  For successful, we follow the configuration meaning we only post an update to the Remedy ticket if the configuration so indicates.</parameter>
    </parameters><messages>
        <message type="Create"/>
        <message type="Update"/>
        <message type="Complete"/>
      </messages>
      <dependents/>
    </task>
      </request>
</taskTree></tree>